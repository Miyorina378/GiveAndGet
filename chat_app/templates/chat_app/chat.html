{% extends 'main_app/components/base.html' %}
{% load static %}

{% block content %}
{% load static %}

<link rel="stylesheet" href="{% static 'chat_app/chat_app.css' %}">

<div class="container-fluid h-100">
  <div class="row h-100">
    <!-- User List Sidebar -->
    <div class="col-3 sidebar p-3 chats">
      <h5 class="mb-3 text-white">Messages</h5>
      <div class="contacts">
        <div class="pro_list mb-3 text-white">
          <h6 style="font-weight: bold;">
            </h6style>{{ room_name }}'s Product List : </h6>
          {% if products %}
          {% for product in products %}
          <li>{{ product.name }} - ฿{{ product.price }}</li>
          {% endfor %}
          {% else %}
          <p>No products available for this user.</p>
          {% endif %}
        </div>
        {% for item in user_last_messages %}
        <a href="{% url 'chat_room' item.user.username %}"
          class="list-group-item list-group-item-action {% if item.user.username == room_name %} active {% endif %}"
          data-username="{{ item.user.username }}">
          <div class="d-flex align-items-center">
            <!-- Profile Icon -->
            <img src="{% if item.user.profile_picture %}
                                {{ item.user.profile_picture.url }}
                                {% else %}
                                  {% static 'users_app/images/default.png' %}
                                {% endif %}" alt="{{ item.user.username }}'s Profile Image" class="profile-icon"
              style="width: 1.8rem; height: 1.8rem; object-fit: cover" />
            <!-- Message Content -->
            <div class="w-100">
              <div class="d-flex justify-content-between">
                <strong class="text-truncate">{{ item.user.username }}</strong>
                {% if item.last_message %}
                <small class="text-nowrap timestamp">{{ item.last_message.timestamp|date:"H:i" }}</small>
                {% endif %}
              </div>
              <div>
                {% if item.last_message %}
                <small class="d-block text-truncate last-msg" style="max-width: 90%" id="last-message">
                  {% if item.last_message.sender == request.user %}

                  {% endif %}
                  {{ item.last_message.content|truncatewords:5 }}
                </small>
                {% else %}
                <small>No messages yet</small>
                {% endif %}
              </div>
            </div>
            <!-- Unread Badge -->
            {% if item.unread_count > 0 %}
            <span class="badge badge-danger unread-badge">{{ item.unread_count }}</span>
            {% endif %}
          </div>
        </a>
        {% endfor %}
      </div>
    </div>


    <!-- Chat Area -->
    <div class="col-9 d-flex flex-column chat" data-id="{{ room_name }}">
      <!-- Chat Header -->
      <div class="d-flex align-items-center p-1 chat-header">
        <!-- รูปโปรไฟล์ -->
        <img src="{% if seller.profile_picture %}
              {{ seller.profile_picture.url }}
          {% else %}
            {% static 'users_app/images/default.png' %}
          {% endif %}" style="border-radius: 30%; height: 50px; width: auto;" />
        <!-- ชื่อห้องแชท -->
        <h3 class="display-5 mb-0 pl-2">{{ room_name }}</h3>

        <!-- ปุ่มและช่องค้นหา -->
        <div class="ml-auto d-flex align-items-center">
          <!-- ปุ่มคำขอแลกเปลี่ยน -->
          <button type="button" id="tradeButton" class="btn btn-success mr-2">
            Send Trade Request
          </button>
          <!-- ช่องค้นหา -->
          <div class="form-group mb-0">
            <input type="text" name="search" id="searchInput" class="form-control rounded"
              placeholder="Search messages..." value="{{ search_query }}" style="border-radius: 20px; width: 250px;" />
          </div>
        </div>
      </div>

      <!-- Chatbox -->
      <div id="chatbox" class="chatbox flex-fill p-3">
        {% if chats %}
        {% for message in chats %}
        <div class="chat-message {% if message.sender == request.user %} sender {% else %} receiver {% endif %}">
          <span>{{ message.message }}</span>
        </div>
        {% endfor %}
        {% else %}
        <p class="no-messages">No Messages.</p>
        {% endif %}
      </div>

      <!-- Message Input -->
      <div class="chat-input p-3">
        <div class="input-group">
          <input type="text" id="my_input" class="form-control" placeholder="Type a message..." required />
          <div class="input-group-append">
            <button id="submit_button" class="btn btn-primary" type="button">
              Send
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop -->
<div class="backdrop" id="backdrop"></div>

<!-- Trade Modal -->
<div class="modal" id="tradeModal">
  <div class="modal-header">ตกลงซื้อขาย</div>
  <div class="modal-body">
    <form id="tradeForm">
      <!-- Product Selection -->
      <div class="form-group">
        <label for="productSelect">เลือกสินค้าที่ต้องการ:</label>
        <select id="productSelect" class="form-control">
          <option value="">-- กรุณาเลือกสินค้า --</option>
          {% for product in products %}
          <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Payment Method Selection -->
      <div class="form-group">
        <label>เลือกวิธีชำระเงิน:</label>
        <select id="paymentMethod" class="form-control">
          <option value="money">จ่ายด้วยเงิน</option>
          <option value="items">แลกเปลี่ยนด้วยของ</option>
        </select>
      </div>
      <div class="form-group" id="exchangeItemInput" style="display: none;">
        <label for="exchangeItem">สิ่งที่ต้องการแลก:</label>
        <input type="text" id="exchangeItem" class="form-control" placeholder="ใส่สิ่งที่คุณต้องการแลก" />
      </div>
      <div class="form-group" id="locationInput">
        <label>พิกัดสถานที่:</label>
        <input type="text" id="location" class="form-control" placeholder="ใส่พิกัดที่อยู่สำหรับการแลกเปลี่ยน" />
      </div>
      <div class="form-group">
        <label for="appointmentDate">วันนัดรับ:</label>
        <input type="date" id="appointmentDate" class="form-control" />

        <label for="appointmentTime">เวลานัดรับ:</label>
        <input type="time" id="appointmentTime" class="form-control" />
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button type="button" id="cancelTrade" class="btn btn-secondary">ยกเลิก</button>
    <button type="button" id="confirmTrade" class="btn btn-primary">ยืนยัน</button>
  </div>
</div>

{{ slug|json_script:"room_slug" }}

<script>
  const chatbox = document.querySelector("#chatbox");

  // Scroll to the bottom of the chatbox
  function scrollToBottom() {
    chatbox.scrollTop = chatbox.scrollHeight;
  }
  scrollToBottom();

  const roomName = JSON.parse(
    document.getElementById("room_slug").textContent
  );
  const chatSocket = new WebSocket(
    "ws://" + window.location.host + "/ws/chat/{{ room_name }}/"
  );

  chatSocket.onopen = function (e) {
    console.log("The connection was set up successfully!");
  };
  chatSocket.onclose = function (e) {
    console.log("The connection was closed.");
  };

  document.querySelector("#my_input").focus();
  document.querySelector("#my_input").onkeyup = function (e) {
    if (e.keyCode == 13) {
      e.preventDefault();
      document.querySelector("#submit_button").click();
    }
  };

  document.querySelector("#submit_button").onclick = function (e) {
    const messageInput = document.querySelector("#my_input").value;
    if (messageInput.trim().length === 0) {
      alert("Please enter a message.");
    } else {
      chatSocket.send(
        JSON.stringify({
          message: messageInput,
          username: "{{ request.user.username }}",
          room_name: "{{ room_name }}",
        })
      );
      document.querySelector("#my_input").value = ""; // Clear input
    }
  };

  chatSocket.onmessage = function (e) {
    const data = JSON.parse(e.data);
    if (data.message && data.sender) {
      // Add message to chatbox
      const div = document.createElement("div");
      div.className =
        "chat-message " +
        (data.sender === "{{ request.user.username }}" ? "sender" : "receiver");
      div.innerHTML = `<div><span>${data.message}</span></div>`;
      chatbox.appendChild(div);

      // Scroll to bottom
      scrollToBottom();

      // Update last message in the sidebar
      const senderElement = document.querySelector(
        `.list-group-item[data-username="${data.sender}"]`
      );
      if (senderElement) {
        const lastMessage = senderElement.querySelector("#last-message");
        if (lastMessage) {
          lastMessage.textContent =
            data.sender === "{{ request.user.username }}"
              ? "You: " + data.message
              : data.message;
        }

        const timestamp = senderElement.querySelector("small.timestamp");
        if (timestamp) {
          const date = new Date();
          timestamp.textContent = date.toTimeString().slice(0, 5);
        }

        // Update unread count
        let badge = senderElement.querySelector(".badge");
        if (!badge) {
          badge = document.createElement("span");
          badge.className = "badge badge-danger unread-badge";
          badge.textContent = "1";  // Assuming this is a new unread message
          senderElement.appendChild(badge);
        } else {
          badge.textContent = parseInt(badge.textContent) + 1;
        }
      }
    }
  };

  // Mark messages as read when user enters the chat room
  if (document.querySelector(".chat-message")) {
    const badge = document.querySelectorAll(".unread-badge");
    badge.forEach(function (badge) {
      badge.parentElement.removeChild(badge);  // Remove badge when user enters the chat
    });
  }

  // Show modal
  tradeButton.addEventListener("click", () => {
    backdrop.style.display = "block";
    tradeModal.style.display = "block";
  });

  // Hide modal
  const closeModal = () => {
    backdrop.style.display = "none";
    tradeModal.style.display = "none";
  };

  backdrop.addEventListener("click", closeModal);
  cancelTrade.addEventListener("click", closeModal);

  document.getElementById('paymentMethod').addEventListener('change', function () {
    var exchangeItemInput = document.getElementById('exchangeItemInput');
    if (this.value === 'items') {
      exchangeItemInput.style.display = 'block';  // แสดงฟิลด์สิ่งที่ต้องการแลก
    } else {
      exchangeItemInput.style.display = 'none';   // ซ่อนฟิลด์สิ่งที่ต้องการแลก
    }
  });

  // Fetch the user's products when the modal opens
  document.addEventListener("DOMContentLoaded", function () {
    // Function to fetch and populate the product select dropdown
    fetch("/get-user-products/", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    })
      .then((response) => response.json())
      .then((data) => {
        const productSelect = document.getElementById("productSelect");
        productSelect.innerHTML = ""; // Clear existing options

        // If products are found, create options for the select dropdown
        if (data.success && data.products.length > 0) {
          data.products.forEach((product) => {
            const option = document.createElement("option");
            option.value = product.id;
            option.textContent = `${product.name} - ฿${product.price}`;
            productSelect.appendChild(option);
          });
        } else {
          // If no products, show a message
          const option = document.createElement("option");
          option.value = "";
          option.textContent = "ไม่มีสินค้าสำหรับผู้ใช้นี้";
          productSelect.appendChild(option);
        }
      })
      .catch((error) => console.error("Error fetching products:", error));
  });

  // Confirm trade and submit the trade request
  document.getElementById("confirmTrade").addEventListener("click", function () {
    const productId = document.getElementById("productSelect").value; // Get selected product ID
    const paymentMethod = document.getElementById("paymentMethod").value;
    const location = document.getElementById("location").value;

    // Make sure all fields are filled
    if (!productId || !paymentMethod) {
      alert("กรุณากรอกข้อมูลให้ครบถ้วน");
      return;
    }

    // Send the trade request via AJAX
    fetch("/submit-trade-request/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken"), // Ensure CSRF token is included
      },
      body: JSON.stringify({
        product_id: productId,
        payment_method: paymentMethod,
        location: location,
      }),
    })
      .then((response) => response.json())
      .then((data) => {
        if (data.success) {
          alert("คำขอแลกเปลี่ยนถูกส่งแล้ว!");
          location.reload(); // Reload the page if necessary
        } else {
          alert("เกิดข้อผิดพลาด: " + data.message);
        }
      })
      .catch((error) => {
        console.error("Error:", error);
        alert("เกิดข้อผิดพลาดในการส่งคำขอ");
      });
  });

  // CSRF Token Helper (to get the CSRF token from cookies)
  function getCookie(name) {
    const cookieValue = document.cookie
      .split("; ")
      .find((row) => row.startsWith(name + "="))
      ?.split("=")[1];
    return cookieValue || "";
  }


</script>


{% endblock %}